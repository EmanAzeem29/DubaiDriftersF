<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Confirmed - Dubai Drifters</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { 
      font-family: 'Poppins', sans-serif; 
      background-color: #FDF6EC;
    }
    
    .header-gradient {
      background: linear-gradient(to right, #000000, #1a1a1a, #0d0d0d);
    }
    
    .progress-bar {
      height: 6px;
      background-color: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background-color: #C89B52;
      transition: width 0.5s ease;
    }
    
    .mobile-menu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .mobile-menu.open {
      max-height: 500px;
    }
    
    .confirmation-check {
      animation: checkmark 0.5s ease-in-out;
    }
    
    @keyframes checkmark {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background-color: #10B981;
    }

    .toast.error {
      background-color: #EF4444;
    }

    .toast.info {
      background-color: #3B82F6;
    }

    /* Loading spinner */
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <header class="header-gradient text-white shadow-lg sticky top-0 z-50">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center py-2">
        <!-- Logo + Name -->
        <a href="index.html" class="flex items-center space-x-4">
          <img src="logo.jpg" alt="Logo" 
               class="h-16 w-16 rounded-full object-cover border-4 border-[#C89B52] shadow-lg hover:scale-110 transition-transform duration-300"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMzIiIGZpbGw9IiNDODlCNTIiLz4KPHN2Zz4K'"/>
          <span class="text-2xl font-bold tracking-wide text-[#C89B52]">Dubai Drifters</span>
        </a>
        
        <!-- Desktop Menu -->
        <div class="hidden md:flex items-center space-x-6 text-sm text-white font-medium">
          <a class="hover:text-[#C89B52] transition-colors duration-300 hover:scale-105" href="about.html">About Us</a>
          <a class="hover:text-[#C89B52] transition-colors duration-300 hover:scale-105" href="contact.html">Contact Us</a>
          <a class="hover:text-[#C89B52] transition-colors duration-300 hover:scale-105" href="blog.html">Blog</a>

          <a class="flex items-center hover:text-[#C89B52] transition duration-300 hover:scale-105" href="#">
            <span class="material-icons text-lg mr-1">person</span>
            <span>Sign In</span>
          </a>
        </div>
        
        <!-- Mobile Menu Button -->
        <div class="md:hidden">
          <button id="mobileMenuBtn" class="text-white hover:text-[#C89B52] transition duration-300">
            <span class="material-icons">menu</span>
          </button>
        </div>
      </div>

      <hr class="opacity-20 border-[#C89B52]"/>

      <!-- Desktop Nav Links -->
      <nav class="hidden md:flex justify-center items-center py-3 space-x-8 text-sm font-semibold text-white">
        <a href="index.html" class="hover:text-[#C89B52] transition duration-300 hover:scale-105">Home</a>
        <a href="tours.html" class="hover:text-[#C89B52] transition duration-300 hover:scale-105">Tours</a>
        <a href="visa.html" class="hover:text-[#C89B52] transition duration-300 hover:scale-105">Visa</a>
        <a href="about.html" class="hover:text-[#C89B52] transition duration-300 hover:scale-105">About Us</a>
        <a href="blog.html" class="hover:text-[#C89B52] transition duration-300 hover:scale-105">Blog</a>
        <a href="contact.html" class="hover:text-[#C89B52] transition duration-300 hover:scale-105">Contact</a>
      </nav>
      
      <!-- Mobile Menu -->
      <div id="mobileMenu" class="mobile-menu md:hidden bg-[#1a1a1a] rounded-b-lg shadow-lg">
        <div class="py-4 px-4 space-y-4">
          <a class="block text-white hover:text-[#C89B52] transition duration-300" href="index.html">Home</a>
          <a class="block text-white hover:text-[#C89B52] transition duration-300" href="tours.html">Tours</a>
          <a class="block text-white hover:text-[#C89B52] transition duration-300" href="visa.html">Visa</a>
          <a class="block text-white hover:text-[#C89B52] transition duration-300" href="about.html">About Us</a>
          <a class="block text-white hover:text-[#C89B52] transition duration-300" href="blog.html">Blog</a>
          <a class="block text-white hover:text-[#C89B52] transition duration-300" href="contact.html">Contact</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Confirmation Section -->
  <section class="py-12 container mx-auto px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Progress Bar -->
      <div class="mb-8">
        <div class="flex justify-between mb-2">
          <span class="text-sm font-medium text-gray-500">Cart</span>
          <span class="text-sm font-medium text-gray-500">Booking Details</span>
          <span class="text-sm font-medium text-[#C89B52]">Confirmation</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 100%"></div>
        </div>
      </div>

      <!-- Confirmation Content -->
      <div class="bg-white rounded-lg shadow-lg p-8 text-center">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 confirmation-check">
          <span class="material-icons text-green-500 text-4xl">check_circle</span>
        </div>
        
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Booking Confirmed!</h1>
        <p class="text-gray-600 mb-6">Thank you for your booking with Dubai Drifters. Your order has been successfully processed.</p>
        
        <div class="bg-gray-50 rounded-lg p-6 mb-8">
          <div class="flex justify-between items-center mb-4">
            <span class="text-gray-600">Order ID:</span>
            <span id="orderId" class="font-bold text-gray-800">DD-000000</span>
          </div>
          <div class="flex justify-between items-center mb-4">
            <span class="text-gray-600">Payment Method:</span>
            <span id="paymentMethod" class="font-bold text-gray-800">EasyPaisa</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Booking Date:</span>
            <span id="bookingDate" class="font-bold text-gray-800">January 1, 2025</span>
          </div>
        </div>
        
        <div class="mb-8">
          <h2 class="text-xl font-bold text-gray-800 mb-4">What's Next?</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <span class="material-icons text-blue-500">email</span>
              </div>
              <p class="text-sm text-gray-600">You will receive a confirmation email shortly</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
              <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <span class="material-icons text-green-500">support_agent</span>
              </div>
              <p class="text-sm text-gray-600">Our team will contact you within 24 hours</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
              <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <span class="material-icons text-purple-500">calendar_today</span>
              </div>
              <p class="text-sm text-gray-600">Prepare your documents for the tour</p>
            </div>
          </div>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="index.html" class="inline-flex items-center bg-[#C89B52] hover:bg-[#b38642] text-white font-semibold px-6 py-3 rounded-lg shadow-lg transition">
            <span class="material-icons mr-2">home</span>
            Back to Home
          </a>
          <a href="tours.html" class="inline-flex items-center bg-gray-600 hover:bg-gray-700 text-white font-semibold px-6 py-3 rounded-lg shadow-lg transition">
            <span class="material-icons mr-2">explore</span>
            Browse More Tours
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white">
    <div class="container mx-auto px-4 py-10">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h4 class="font-bold text-lg mb-4">About Dubaidrifters.com</h4>
          <p class="text-sm text-gray-400">Your trusted partner for exploring the wonders of Dubai. We provide a wide range of tours, activities, and travel services to make your trip memorable.</p>
        </div>
        <div>
          <h4 class="font-bold text-lg mb-4">Support</h4>
          <ul class="space-y-2 text-sm">
            <li><a class="text-gray-400 hover:text-white" href="contact.html">Contact Us</a></li>
            <li><a class="text-gray-400 hover:text-white" href="#">FAQs</a></li>
            <li><a class="text-gray-400 hover:text-white" href="termsandconditions.html">Terms & Conditions</a></li>
            <li><a class="text-gray-400 hover:text-white" href="#">Privacy Policy</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-bold text-lg mb-4">Follow Us</h4>
          <div class="flex space-x-2">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <!-- Facebook -->
            <a class="text-gray-400 hover:text-white" href="https://www.facebook.com/YourPageName" target="_blank">
              <i class="fab fa-facebook"></i>
            </a>

            <!-- WhatsApp -->
            <a class="text-gray-400 hover:text-white" href="https://wa.me/923001234567" target="_blank">
              <i class="fab fa-whatsapp"></i>
            </a>

            <!-- Instagram -->
            <a class="text-gray-400 hover:text-white" href="https://www.instagram.com/YourUsername" target="_blank">
              <i class="fab fa-instagram"></i>
            </a>
          </div>
          <h4 class="font-bold text-lg mt-6 mb-4">Payment Methods</h4>
          <div class="flex space-x-2">
            <a href="https://www.easypaisa.com.pk" 
               target="_blank" 
               rel="noopener noreferrer"
               class="text-xs bg-gray-700 px-2 py-1 rounded hover:bg-gray-600 transition">
               EasyPaisa
            </a>
          </div>
        </div>
        <div>
          <h4 class="font-bold text-lg mb-4">Newsletter</h4>
          <p class="text-sm text-gray-400 mb-4">Subscribe to our newsletter for exclusive offers and updates.</p>
          <form id="newsletterForm" class="flex">
            <input id="newsletterEmail" class="w-full rounded-l-md p-2 text-gray-800 focus:outline-none" placeholder="Your email" type="email" required/>
            <button id="newsletterBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-r-md transition-colors flex items-center" type="submit">
              <span id="newsletterBtnText">Subscribe</span>
              <div id="newsletterSpinner" class="loading-spinner hidden"></div>
            </button>
          </form>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-8 pt-6 text-center text-sm text-gray-500">
        <p>© 2025 Dubaidrifters.com. All Rights Reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <script>
    // API Configuration
    const API_BASE_URL = 'https://your-backend-domain.com/api'; // Replace with your actual backend URL

    // Utility Functions
    const showToast = (message, type = 'info', duration = 5000) => {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div class="flex items-center">
          <span class="material-icons mr-2">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
          ${message}
        </div>
      `;
      
      document.getElementById('toastContainer').appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, duration);
    };

    // API Functions
    const api = {
      async get(url) {
        try {
          const response = await fetch(`${API_BASE_URL}${url}`);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (error) {
          console.error('API GET Error:', error);
          throw error;
        }
      },

      async post(url, data) {
        try {
          const response = await fetch(`${API_BASE_URL}${url}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (error) {
          console.error('API POST Error:', error);
          throw error;
        }
      }
    };

    // Booking Functions
    const confirmBooking = async (bookingData) => {
      try {
        const response = await api.post('/bookings/confirm', bookingData);
        return response.data || response.booking;
      } catch (error) {
        console.error('Error confirming booking:', error);
        throw error;
      }
    };

    const getBookingDetails = async (bookingId) => {
      try {
        const response = await api.get(`/bookings/${bookingId}`);
        return response.data || response.booking;
      } catch (error) {
        console.error('Error fetching booking details:', error);
        throw error;
      }
    };

    // Newsletter Functions
    const subscribeToNewsletter = async (email) => {
      try {
        await api.post('/newsletter/subscribe', { email });
        return true;
      } catch (error) {
        console.error('Error subscribing to newsletter:', error);
        throw error;
      }
    };

    document.addEventListener("DOMContentLoaded", async function() {
      // Mobile menu toggle
      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const mobileMenu = document.getElementById("mobileMenu");
      
      if(mobileMenuBtn && mobileMenu) {
        mobileMenuBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          mobileMenu.classList.toggle("open");
          // Change icon based on state
          const icon = mobileMenuBtn.querySelector(".material-icons");
          if(mobileMenu.classList.contains("open")) {
            icon.textContent = "close";
          } else {
            icon.textContent = "menu";
          }
        });
        
        // Close mobile menu when clicking outside
        document.addEventListener("click", (e) => {
          if(!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
            mobileMenu.classList.remove("open");
            mobileMenuBtn.querySelector(".material-icons").textContent = "menu";
          }
        });
      }

      // Load and process booking data
      const pendingBookingData = JSON.parse(localStorage.getItem("pendingBookingData"));
      const bookingId = new URLSearchParams(window.location.search).get('bookingId');
      
      let finalBookingData = null;

      try {
        if (bookingId) {
          // If booking ID is provided in URL, fetch from backend
          finalBookingData = await getBookingDetails(bookingId);
        } else if (pendingBookingData) {
          // If pending booking data exists, confirm booking with backend
          finalBookingData = await confirmBooking(pendingBookingData);
          
          // Clear pending data from localStorage
          localStorage.removeItem("pendingBookingData");
          
          // Update URL with booking ID for sharing
          if (finalBookingData && finalBookingData.id) {
            const newUrl = `${window.location.pathname}?bookingId=${finalBookingData.id}`;
            window.history.replaceState({}, '', newUrl);
          }
        } else {
          // No booking data found, redirect to tours
          showToast('No booking data found. Redirecting to tours page.', 'error');
          setTimeout(() => {
            window.location.href = "tours.html";
          }, 2000);
          return;
        }

        // Display booking confirmation details
        if (finalBookingData) {
          document.getElementById("orderId").textContent = finalBookingData.orderId || finalBookingData.id || 'DD-' + Math.random().toString(36).substr(2, 9).toUpperCase();
          document.getElementById("paymentMethod").textContent = finalBookingData.paymentMethod || 'EasyPaisa';
          
          const bookingDate = new Date(finalBookingData.createdAt || finalBookingData.timestamp || Date.now());
          document.getElementById("bookingDate").textContent = bookingDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });

          // Send confirmation email via backend
          try {
            await api.post('/bookings/send-confirmation', {
              bookingId: finalBookingData.id || finalBookingData.orderId,
              customerEmail: finalBookingData.customerEmail,
              customerName: finalBookingData.customerName
            });
          } catch (emailError) {
            console.warn('Failed to send confirmation email:', emailError);
            // Continue even if email fails
          }

          showToast('Booking confirmed successfully!', 'success');
        }

      } catch (error) {
        console.error('Error processing booking:', error);
        showToast('Failed to process booking. Please contact support.', 'error');
        
        // Fallback to localStorage data if available
        const fallbackData = JSON.parse(localStorage.getItem("finalBookingData"));
        if (fallbackData) {
          document.getElementById("orderId").textContent = fallbackData.orderId;
          document.getElementById("paymentMethod").textContent = fallbackData.paymentMethod;
          
          const bookingDate = new Date(fallbackData.timestamp);
          document.getElementById("bookingDate").textContent = bookingDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        }
      }

      // Newsletter subscription
      const newsletterForm = document.getElementById("newsletterForm");
      const newsletterEmail = document.getElementById("newsletterEmail");
      
      if(newsletterForm && newsletterEmail) {
        newsletterForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          if(newsletterEmail.value && newsletterEmail.value.includes("@")) {
            const btn = document.getElementById("newsletterBtn");
            const btnText = document.getElementById("newsletterBtnText");
            const spinner = document.getElementById("newsletterSpinner");
            
            btn.disabled = true;
            btnText.textContent = 'Subscribing...';
            spinner.classList.remove("hidden");
            
            try {
              await subscribeToNewsletter(newsletterEmail.value);
              btnText.textContent = 'Subscribe';
              spinner.classList.add("hidden");
              newsletterEmail.value = '';
              showToast('Successfully subscribed to our newsletter!', 'success');
            } catch (error) {
              btnText.textContent = 'Subscribe';
              spinner.classList.add("hidden");
              showToast('Failed to subscribe. Please try again.', 'error');
            } finally {
              btn.disabled = false;
            }
          } else {
            showToast('Please enter a valid email address.', 'error');
          }
        });
      }

      // Check backend health on load
      try {
        await api.get('/health');
        console.log('Backend is connected');
      } catch (err) {
        console.warn('Backend not reachable, using fallback functionality');
      }
    });
  </script>
</body>
</html>